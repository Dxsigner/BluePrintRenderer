<html>
	<head>
		<meta charset="UTF-8">
		<style>
			* { margin:0; padding:0; } /* to remove the top and left whitespace */

			html, body { width:100%; height:100%; } /* just to be sure these are full screen*/

			canvas { display:block; position: absolute; left: 0; top:0;} /* To remove the scrollbars */
			#gridCanvas { z-index: 1; background: #262626;};
			#mainCanvas { z-index: 2;};
			#container {overflow: auto};

		</style>
		<script src="/js/svg.js"></script>
		<script src="/js/svg.filter.js"></script>
		<script src="/js/jsface.js"></script>
		<script src="/js/vector.js"></script>
		<script src="/js/app/SVG.js"></script>
		<script src="/js/app/Drawers/LinksDrawer.js"></script>
		<script src="/js/app/Drawers/NodesDrawer.js"></script>


		<script src="/js/app/Globals.js"></script>

		<script src="/js/app/Parser/BPParser.js"></script>
		<script src="/js/app/Parser/BPToNodes.js"></script>

		<script src="/js/app/Nodes/AbstractNode.js"></script>
		<script src="/js/app/Nodes/CommentNode.js"></script>
		<script src="/js/app/Nodes/FunctionNode.js"></script>
		<script src="/js/app/Nodes/GetterNode.js"></script>
		<script src="/js/app/Nodes/SetterNode.js"></script>
		<script src="/js/app/Nodes/EventNode.js"></script>
		<script src="/js/app/Nodes/ConverterNode.js"></script>
		<script src="/js/app/Nodes/BinaryOperatorNode.js"></script>
		<script src="/js/app/Nodes/MacroNode.js"></script>
	</head>
	<body style="overflow: hidden">
		<script>

			window.addEventListener("load", onLoad, false);
			window.addEventListener('resize', onResize, true);
			window.addEventListener('paste', onPaste, true);
			var objects = [];
			var nodes = [];
			var isButtonDown = false;
			var clickPoint = null;
			var uberGroup = null;
			var linksSvg = null;
			var origin = new Vector(0, 0);
			var currentScale = 1;

			function onResize() {
				//globalStack.resizeAll();
			}

			function onPaste(e) {
				var content;

				e.preventDefault();

				console.log(e);
			}

			function getRandomInt(min, max) {
				return Math.floor(Math.random() * (max - min)) + min;
			}
			function onLoad()
			{
				var client = new XMLHttpRequest();
				client.open('GET', '/file.txt');
				client.onreadystatechange = function () {
					if (client.readyState === 4 && client.status === 200)
					{
						if (client.responseText)
							parse(client.responseText);
					}
				}
				client.send();

				console.log(document.getElementById('svgContainer'));

				var el = document.getElementById('svgContainer')
				el.addEventListener('wheel', function (e) {
					var sign = e.deltaY > 0 && -1 || 1;

					var newScale = currentScale + sign * 0.3;
					var point = getCoords(e);
					uberGroup.animate(100, '>').scale(newScale).during(function (pos) {
						//	uberGroup.move(-sign*point.x*pos+origin.x,-sign*point.y*pos+origin.y);console.log(pos);
					}).after(function () {
						origin.x = uberGroup.x();
						origin.y = uberGroup.y();
						currentScale = newScale;
					});

				});

				el.addEventListener('contextmenu', function (ev) {
					ev.preventDefault();
					return false;
				}, false);

				makeUnselectable(el);
			}



			function draw() {
				var nodes = BPToNodes(objects);

				var drawerWidth = window.innerWidth;
				var drawerHeight = window.innerHeight;

				var mainDrawer = SVG('svgContainer').size(drawerWidth, drawerHeight);
				var linksDrawer = new LinksDrawer(nodes, mainDrawer);
				var nodesDrawer = new NodesDrawer(nodes, mainDrawer);
				//console.log('maxes', maxX, maxY)
				//must know width & height!
				//	maxX += 200;
				//maxY += 200;

				//var drawerWidth = (maxX > window.innerWidth) && maxX || window.innerWidth;
				//var drawerHeight = (maxY > window.innerHeight) && maxY || window.innerHeight;

				var grid = mainDrawer.group();
				var gridRect = grid.rect(drawerWidth, drawerHeight).fill({color: '#262626'});
				var gridStep = 17;

				for (var p = gridStep; p < drawerWidth; p += gridStep) {
					grid.line(p, 0, p, drawerHeight).stroke({width: 1, color: '#343434'})
				}

				for (var p = gridStep; p < drawerHeight; p += gridStep) {
					grid.line(0, p, drawerWidth, p).stroke({width: 1, color: '#343434'})
				}

				for (var p = (gridStep * 8); p < drawerWidth; p += gridStep * 8) {
					grid.line(p, 0, p, drawerHeight).stroke({width: 1, color: '#161616'})

				}

				for (var p = (gridStep * 8); p < drawerHeight; p += gridStep * 8) {
					grid.line(0, p, drawerWidth, p).stroke({width: 1, color: '#161616'})
				}
				
				var nodes = nodesDrawer.render();
				var links = linksDrawer.render();
				links.back();
				grid.back();
				uberGroup = mainDrawer.group();
				
				uberGroup.add(links);
				uberGroup.add(nodes);







				mainDrawer.mousemove(function (e) {
					if (isButtonDown) {
						var delta = getCoords(e).subtract(clickPoint);
						uberGroup.move(origin.x + delta.x, origin.y + delta.y);
					}

				});

				mainDrawer.mousedown(function (e) {
					if (e.button === 2)
						isButtonDown = true;
					clickPoint = getCoords(e);
					console.log('uber', uberGroup.x(), uberGroup.y())
				});

				mainDrawer.mouseup(function (e) {
					isButtonDown = false;
					console.log('newOrigin', uberGroup.x(), uberGroup.y())
					origin.x = uberGroup.x();
					origin.y = uberGroup.y();
				});

			}

			function parse(text) {
				var parser = new BPParser(text);
				objects = parser.parseText();
				draw();
			}

			function getCoords(e) {
				var can = document.getElementById('svgContainer');
				var x, y;
				if (e.pageX || e.pageY) {
					x = e.pageX;
					y = e.pageY;
				}
				else {
					x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
					y = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
				}

				x -= can.offsetLeft;
				y -= can.offsetTop;

				return new Vector(x, y);
			}

			function makeUnselectable(node) {
				/*if (node.nodeType == 1) {
				 //node.style('pointer-events', 'none');
				 }
				 var child = node.firstChild;
				 while (child) {
				 makeUnselectable(child);
				 child = child.nextSibling;
				 }*/
			}

		</script>
		<div id="svgContainer"></div>
		<div id="tmpSvgContainer"></div>
	</body>




</html>
