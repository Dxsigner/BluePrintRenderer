<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Hello World</title>
        <style>
            * { margin:0; padding:0; }
            html, body { width:100%; height:100%;}
            body {overflow: hidden;}
        </style>
    </head>
    <script src="node_modules/pixi.js/dist/pixi.min.js"></script>

    <script src="src/libs/pixi-display.js"></script>

    <script src="src/App/BlueprintRenderer.js"></script>

    <script src="src/Parser/BPParser.js"></script>
    <script src="src/Parser/BPToNodes.js"></script>

    <script src="src/Globals/Config.js"></script>

    <script src="src/Grid/Grid.js"></script>
    <script src="src/Drawers/LinksDrawer.js"></script>
    <script src="src/Drawers/Link.js"></script>

    <script src="src/Nodes/RegularNode.js"></script>
    <script src="src/Nodes/FunctionNode.js"></script>
    <script src="src/Nodes/EventNode.js"></script>
    <script src="src/Textures/Textures.js"></script>
    <script src="src/Nodes/VarNode.js"></script>
    <script src="src/Nodes/SetterNode.js"></script>
    <script src="src/Nodes/GetterNode.js"></script>
    <script src="src/Nodes/BinaryOperatorNode.js"></script>
    <script src="src/Nodes/MacroNode.js"></script>
    <script src="src/Nodes/CommentNode.js"></script>

    <script src="src/libs/vector.js"></script>
    <body>
        <script type="text/javascript">


            var app = new PIXI.Application(document.body.parentNode.clientWidth, window.innerHeight, {backgroundColor: 0x2a2a2a, antialias: true});
            app.stage.displayList = new PIXI.DisplayList();
            document.body.appendChild(app.view);
            console.log(app);

            var grid = new Grid(app, 0, 0);

            var texturesHandler = new TexturesHandler();

            var dragging = false;

            var eventData = null;


            var mainContainer = new PIXI.Container();

            var allNodes = [];

            var linksDrawer;

            var nodesLayer = new PIXI.DisplayGroup(1, true);
            var linksLayer = new PIXI.DisplayGroup(0, true);

            var linksContainer = new PIXI.Container();
            app.stage.addChild(linksContainer);

            app.renderer.plugins.interaction
                    .on('pointerdown', onDragStart)
                    .on('pointerup', onDragEnd)
                    .on('pointerupoutside', onDragEnd)
                    .on('pointermove', onDragMove);

            app.stage.addChild(mainContainer);

            var render = new BlueprintRenderer();
            render.renderFromFile("/tests/file_big.txt", function (nodes) {
                var nodesObjects = BPToNodes(nodes, texturesHandler);
                for (var i = 0, l = nodesObjects.length; i < l; i++) {
                    nodesObjects[i].draw(mainContainer);
                    allNodes.push(nodesObjects[i]);
                }
                linksDrawer = new LinksDrawer(linksContainer, allNodes);
                var canvas = document.body.querySelector("canvas");
                disableContextMenu(canvas);
            });




            function isRightClick(e) {
                return e.which === 3;
            }

            function disableContextMenu(canvas) {
                canvas.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                });
            }

            function onDragStart(event) {
                if (isRightClick(event.data.originalEvent)) {
                    dragging = true;
                    eventData = event.data;
                }
            }

            function onDragEnd(event) {
                if (isRightClick(event.data.originalEvent)) {
                    dragging = false;
                    eventData = null;
                }

            }

            function onDragMove(event) {
                if (dragging) {
                    mainContainer.x += event.data.originalEvent.movementX;
                    mainContainer.y += event.data.originalEvent.movementY;

                    linksDrawer.links.x += event.data.originalEvent.movementX;
                    linksDrawer.links.y += event.data.originalEvent.movementY;

                    grid.redraw(event.data.originalEvent.movementX, event.data.originalEvent.movementY)
                }
            }



        </script>
    </body>
</html>
